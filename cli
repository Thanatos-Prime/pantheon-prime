# pantheon_memory_engine/cli.py
import argparse
from textwrap import dedent

from .engine import MemoryEngine


def cmd_add(args: argparse.Namespace) -> None:
    engine = MemoryEngine()
    eid = engine.add_entry(
        kind=args.kind,
        title=args.title,
        body=args.body,
        tags=args.tags or [],
    )
    print(f"Created entry #{eid}")


def cmd_list(args: argparse.Namespace) -> None:
    engine = MemoryEngine()
    entries = engine.list_entries(kind=args.kind, limit=args.limit)
    for e in entries:
        tags = ", ".join(e.tags)
        print(f"[{e.id}] ({e.kind}) {e.title}   tags: {tags}")


def cmd_search(args: argparse.Namespace) -> None:
    engine = MemoryEngine()
    entries = engine.search(args.query, limit=args.limit)
    for e in entries:
        print(f"[{e.id}] ({e.kind}) {e.title}")
        print(dedent(e.body).strip())
        print("-" * 40)


def cmd_link(args: argparse.Namespace) -> None:
    engine = MemoryEngine()
    lid = engine.add_link(from_id=args.from_id, to_id=args.to_id, relation=args.relation)
    print(f"Created link #{lid} ({args.from_id} -[{args.relation}]-> {args.to_id})")


def build_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(prog="pantheon-memory", description="Pantheon Memory Engine v0.1")
    sub = parser.add_subparsers(dest="command", required=True)

    # add
    p_add = sub.add_parser("add", help="Add a new entry")
    p_add.add_argument("--kind", required=True, help="Type of entry: daemon, doctrine, note, event, etc.")
    p_add.add_argument("--title", required=True)
    p_add.add_argument("--body", required=True)
    p_add.add_argument("--tags", nargs="*", help="Tags (space-separated)")
    p_add.set_defaults(func=cmd_add)

    # list
    p_list = sub.add_parser("list", help="List recent entries")
    p_list.add_argument("--kind", help="Filter by kind")
    p_list.add_argument("--limit", type=int, default=20)
    p_list.set_defaults(func=cmd_list)

    # search
    p_search = sub.add_parser("search", help="Search entries (full-text)")
    p_search.add_argument("query")
    p_search.add_argument("--limit", type=int, default=10)
    p_search.set_defaults(func=cmd_search)

    # link
    p_link = sub.add_parser("link", help="Link two entries")
    p_link.add_argument("from_id", type=int)
    p_link.add_argument("to_id", type=int)
    p_link.add_argument("--relation", required=True)
    p_link.set_defaults(func=cmd_link)

    return parser


def main() -> None:
    parser = build_parser()
    args = parser.parse_args()
    args.func(args)


if __name__ == "__main__":
    main()